---
layout: post
title: 3주차
---

## 조우희 : 261 ~ 322 (3.3.8절)

## 김새미나 : 323~ 386 (4.1.6절)
범위: 323~ 386 (4.1.6절)



## 제 4장 인덱스 수립 전략

### 4.1. 인덱스의 선정 기준
최소의 인덱스로 최대의 엑세스 형태를 모두 만족할 수 있도록 하는 전략이 필요
`이 단원을 한 줄로 요약하자면, 어떤 컬럼들로 결합되었는가? 어떤 순서로 결합되었는가?`

##### 4.1.1. 테이블 형태별 적용 기준
- 적은 데이터를 가진 소형 테이블
DB_FILE_MULTIBLOCK_READ_COUNT에 지정된 숫자 이하의 불록을 가진 테이블 (한번에 I/O에서 액세스되는 블록 이내의 크기)의 경우 인덱스 유무가 성능에 거의 미치지 않는다.
하지만 다른 테이브를과 다양한 방법으로 연결되는 경우, 소형 테이블도 인덱스 구성이 바람직하다.
또한, 아무리 소형테이블이라도 기본키는 반드시 인덱스를 가지도록 한다. 기본키는 조인의 실행계획이나 각종 무결성 정의에 영향을 미친다.


- 주로 참조되는 역학을 하는 중대형 테이블
데이터는 많고 많은 랜덤 엑세스가 발생하지만 주기적으로 대량의 데이터가 입력되는 경우가 없는 테이블
즉, 검색 조건의 형태가 뚜렷하고 데이터 증감이 별로 없으며 검색 위주의 액세스가 발생하는 경우
이런 테이블의 인덱스는 설사 인덱스 개수가 좀 많아진다 하더라도 역할에 좀더 잘 맞는 구성으로 과감하게 결정 가능
ex) 고객테이블


- 업무의 구체적인 행위를 관리하는 중대형 테이블
시간이 지남에 따라 데이터가 지속적으로 증가하는 테이블
ex) 매출정보테이블
`인덱스 전략 수집을 위한 절차를 충실히 지켜야 한다.`
    1. 해당 테이블을 액세스하고 있는 모든 유형을 수집한다.
    2. 이 유형들을 가장 이상적으로 만족시킬 수 있는 인덱스 조합을 찾아낸다.
    3. 기존에 사용된 액세스 형태뿐만 아니라 앞으로 예상되는 형태까지도 감안한 인덱스를 구성한다.
    \* 새로운 액세스 유형이 나타났다고 해서 개발자가 해당 쿼리의 최적화만을 위해서 함부로 인덱스를 추가하도록 해서는 안된다.
    


- 저장용 대형 테이블
ex) 로그성테이블


##### 4.1.2. 분포도와 손익분기점
WHERE 절에는 처리범위를 주관하는 것과 단순히 체크 기능만을 담당하는 조건이 있다.
최선의 방법은 가장 처리범위가 적은 것을 처리주관으로 하는 것. 결국 어떻게 인덱스를 구성해야 가장 최소의 범위를 처리할 수 있는가에 달려있다.
인덱스 컬럼의 분포도가 10~15%를 넘지 않아야 인덱스로서의 가치가 있으며 해당 수치가 `손익분기점`을 의미한다.
인덱스 컬럼의 분포도가 10~15%가 기준이라는 것은 그 이상인 경우는 차라리 전체 테이블을 스캔하는 것이 유리하다.


##### 4.1.3. 인덱스 머지와 결합 인덱스 비교 (339p)
인덱스 머지(Index Merge) : 여러 인덱스가 협력하여 같이 액세스를 주관. 머지할 대상이 서로 비슷한 분포도를 가지고 있을 때 유리
결합 인덱스(Concatenated Index) : 여러 개의 컬럼을 모아 하나의 인덱스로 생성시키는 것. 그외에는 주로 결합 인덱스를 사용

##### 4.1.4. 결합 인덱스의 특징
결합 인덱스의 첫 번째 컬럼이 WHERE절에 없다면 일반적으로 인덱스는 사용되지 않는다.
결합 인덱스의 최대의 단점은 컬럼 중 일부만 조건을 받거나 '='이 아닌 연산자가 만이 있으면 급격하게 처리범위가 증가하여 효율이 떨어진다.
이것은 곧 `어떤 컬럼들로 결합되었는가? 어떤 순서로 결합되었는가?`에 대한 매우 치밀한 전략이 필요하다는 것을 의미한다.

- 분포도와 결합순서의 상관관계
분포도가 넓은 컬럼이 앞에 있거나 분포도가 좁은 컬림이 앞에 있거나 모두 '='(Equal)로 사용한 경우에는 실제 처리한 일량의 차이가 없다.


- 이퀄(=)이 결합순서에 미치는 영향
인덱스의 첫번째 컬럼이 '='로 사용되지 않으면 뒤에 있는 컬럼이 비록 '='로 사용되었더라도 처리범위는 줄지 않는다. 결합 인덱스의 컬럼 순서를 결정하는 매우 중요한 판단요소


- IN연산자를 이용한 징검다리 효과
BETWEEN VS IN
between, like는 선분의 개념이지만 IN은 점의 개념이기 때문에 IN으로 되도록 사용 권장


- 처리범위에 직접적인 영향을 주지 못하는 컬럼의 추가 기준 (350p)
결합인덱스가 COL1+COL2+COL3+COL4 로 되어있다고 가정
COL1은 =, COL2은 LIKE, COL3은 >, COL4는 BETWEEN으로 사용되었다면 COL1과 COL2까지는 처리범위를 줄이는데 직접적인 영향을 준다.
COL3, COL4는 앞에 위치한 컬럼이 '='이 아니므로 직접적인 영향을 주지 못하고 체크기능만 담당한다. 그럼에도 불구하고 인덱스 뒤에 추가하는 이유는?
인덱스 엑세스는 스캔 방식이고 테이블 엑세스는 랜덤 방식이기 떄문에 COL3, COL4가 인덱스내에 정렬되어 있기 떄문에 성공한 로우를 바로 추출 가능하다.




##### 4.1.5. 결합 인덱스의 컬럼순서 결정 기준
1단계 : 항상 사용하는가?
2단계 : 항상 '='로 사용하는가?
3단계 : 어느 것이 더 좋은 분포도를 가지는가?
4단계 : 자주 정렬되는 순서는 무엇인가?
5단계 : 부가적으로 추가시킬 컬럼은 어떤 것으로 할 것인가?

##### 4.1.6. 인덱스 선정 절차
인덱스를 설계하는 시점은 크게 두 가지로 나눌 수 있다.
`애플리케이션을 개발하는 단계`와 `시스템이 운영되고 있는 상태에서 시스템 최적화를 위해 인덱스를 재구성`하는 경우가 있다.

- 테이블의 액세스 형태를 최대한으로 수집
    - `개발단계의 액세스 형태 수집` 
    100%는 힘들지만 70~80% 정도의 인덱스 생성 필요
        1) 반복 수행되는 액세스 형태를 찾음
반복 수행되는 액세스는 자신의 수행속도에 반복 횟수를 곱한 만큼 부하를 가져오므로 수행속도에 미치는 영향이 아주 큼 → 기본키, 외부키, 서브쿼리의 컬럼, 루프 내 사용되는 컬럼
        2) 분포도가 아주 양호한 컬럼들을 발췌하여 액세스 유형을 조사
테이블에는 아주 양호한 분포도를 가진 컬럼이 있기 마련 → 단, 분포도 뿐만이 아니라 결합도도 체크
        3) 자주 넓은 범위의 조건이 부여되는 경우를 찾음
인덱스는 넓은 범위를 처리하게 될때 많은 부담을 주게 됨 → 처리범위의 최대 크기와 평균 예상범위, 자주 사용되는 정렬의 순서, 처리 유형(Group by, Order by) 등 활용
        4) 조건에 자주 사용되느 주요 컬럼들을 추출하여 액세스 유형을 조사
빈번하게 사용 된다는 것은 시스템 전반에 미치는 영향이 그 만큼 크기 때문에 아주 중요 → 매출 테이블의 '판매일자', '판매부서', '고객번호', '상태', '상품' 등
        5) 자주 결합되어 사용되는 컬럼들의 조합형태 및 정렬순서 조사
업무적인 측면에서 각 컬럼들간의 상호관계를 잘 파악해 보면 특정 컬럼들끼리 자주 조합하여 사용되는 결합형태를 찾을 수 있음 → 모든 컬럼들간 결합유형을 모두 취할 수 없음, 가장 중심되는 컬럼과 그와 연관성이 가장 큰 컬럼만으로 결합인덱스 생성 또는 클러스터링을 함으로 효율 ↑
        6) 역순으로 정렬하여 추출되는 경우를 찾음
일반적으로 최종 사용자는 조건의 범위는 벏게 부여하면서 결과는 가장 최근에 발생된 데이터부터 보기를 원하는 경우가 많음 → 힌트 사용으로 인덱스 역순 액세스
        7) 통계자료 추출을 위한 액세스 유형 조사
통계자료를 추출하는 경우는 대게 범위가 넓음 → 클러스터링이나 잘 조합된 결합 인덱스 이용
    - `운영단계의 액세스 형태 수집`
        1) 애플리케이션 소스코드에서 SQL을 추출하여 분석용 테이블에 보관
        2) SQL-Trace 파일을 파싱하여 SQL 문장뿐만 아니라 실행계획, 현재 적용되고 있는 인덱스, 실행횟수, 처리범위 등 매우 상세한 정보 획득 가능

    - `수집된 SQL을 테이블 별로 출력하여 액세스 형태 기록`
        
- 인덱스 대상 컬럼의 선정 및 분포도 조사
액세스 유형에 자주 등장하는 컬럼
인덱스의 앞부분에 지정해야 할 컬럼
기타 수행 속도에 영향을 미칠 것으로 예상되는 컬럼
- 특수한 액세스 형태를 최대한으로 수집
반복 액세스 되는 형태(Critical Access Path)를 찾음
반복 수행 액세스는 수행속도에 대하여 반복 수의 배수만큼 증가하기에 0.02초를 0.01초를 줄이는 것이 10초를 1초로 줄이는 것보다 효과적일 수 있음
- 클러스터링 검토
인덱스의 단점
: 넓은 범위 데이터를 인덱스를 경유해 찾을 경우 대량의 랜덤 액세스 발생으로 수행속도 급감
클러스터링으로 넓은 범위의 데이터 효과적 액세스
- 결합 인덱스 구성 및 순서의 결정
각 컬럼간 상호관계를 파악하고 결합 인덱스 구성 및 순서를 결정하여 액세스 수행 속도가 모두가 만족 되도록 함
- 시험생성 및 테스트
인덱스 전략이 새롭게 수립되었으면 운영 중인 시스템에 바로 적용시키지 말고 테스트 과정을 거치도록 한다.
- 수정이 필요한 애플리케이션 조사 및 수정
- 일괄적용
잘못된 SQL의 수정과 인덱스 변경을 동시에 일괄적으로 적용
SQL의 잘못된 점은 수정하기 쉬우나 인덱스는 쉽지 않음
인덱스 수정 시, SQL 수정 발생
